<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <title>Uploader</title>
    <style>
      .aligner {
        text-align: center;
      }
      .b-example-divider {
        height: 3rem;
        background-color: rgba(0, 0, 0, 0.1);
        border: solid rgba(0, 0, 0, 0.15);
        border-width: 1px 0;
        box-shadow: inset 0 0.5em 1.5em rgba(0, 0, 0, 0.1),
          inset 0 0.125em 0.5em rgba(0, 0, 0, 0.15);
      }

      @media (min-width: 992px) {
        .rounded-lg-3 {
          border-radius: 0.3rem;
        }
      }
    </style>
  </head>

    <div class="px-1 pt-1 mt-1 text-center">
      <img src="https://i.ibb.co/gMXfGfS/bench-engine.png" alt="bench-engine"
      border="0" width="180" class="d-block mx-auto"></a>
      <h1 class="display-6 fw-light">Bench Engine</h1>
    </div>

    <div class="px-4 py-5 my-5 text-center">
      <h1 class="display-5 fw-bold">Audio file transcription accuracy benchmarking</h1>
      <div class="col-lg-6 mx-auto">
        <p class="lead mb-4">
          Benchmark audio files transcription accuracy by comparing the
          transcription vs truth key (the correct transctiption of the file).
        </p>


        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mb-3">
          <div class="mb-3">
            <label for="file-to-benchmark" class="form-label">File to benchmark</label>
            <input class="form-control" id="file-to-benchmark" type="file">
            <div class="valid-feedback">Uploaded successfully</div>
            <div class="invalid-feedback">Upload failed</div>
          </div>


          <div class="mb-3">
            <label for="formFileSm" class="form-label drop-key">Truth key (correct transcription)</label>
            <input class="form-control" id="file-truth" type="file">
            <div class="valid-feedback">Uploaded successfully</div>
            <div class="invalid-feedback">Upload failed</div>
          </div>
        </div>


        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mb-3">
          <button type="button" id="benchBtn" class="btn btn-primary btn-lg px-4 gap-3">
            Benchmark
          </button> 
        </div>
        
      </div>
    </div>

    <!-- <div class="b-example-divider"></div> -->

    <script type="text/javascript">
      let fileName;
      let truthName;

      let drop = document.getElementById("file-to-benchmark");
      let truth = document.getElementById("file-truth");
      let button = document.getElementById("benchBtn");

      let basePath = "{{base_path}}"; // filled in by the lambda before serving this page
      let uploadBaseUrl = basePath + "api/file/";

      // Upload on change
      function handleFileChange(e) {
        let files = this.files
        for (let i = 0; i < files.length; i++) {
          let file = files[i];
          let reader = new FileReader();
          reader.addEventListener("loadend", function (e) {
            fetch(uploadBaseUrl + file.name, {
              method: "POST",
              body: new Blob([reader.result], { type: file.type }),
            }).then((response) => {
              if (response.ok) {
                drop.classList.add("is-valid");
                fileName = file.name;
              } else {
                drop.classList.add("is-invalid");
              }
            });
          });
          reader.readAsArrayBuffer(file);
        }
        return false;
      }

      function handleTruthChange(e) {
        let files = this.files
        for (let i = 0; i < files.length; i++) {
          let file = files[i];
          let reader = new FileReader();
          reader.addEventListener("loadend", function (e) {
            fetch(uploadBaseUrl + file.name, {
              method: "POST",
              body: new Blob([reader.result], { type: file.type }),
            }).then((response) => {
              if (response.ok) {
                truth.classList.add("is-valid");
                truthName = file.name;
              } else {
                truth.classList.add("is-invalid");
              }
            });
          });
          reader.readAsArrayBuffer(file);
        }
        return false;
      }

      function handleButtonClick() {
        req = {
          "file_to_transcribe": fileName,
          "truth_key": truthName
        };
        console.log(req);
        alert(JSON.stringify(req));
      }

      drop.addEventListener("change", handleFileChange);
      truth.addEventListener("change", handleTruthChange);
      button.addEventListener("click", handleButtonClick);
    </script>

    <!-- Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
  </body>

  <!-- Based on https://www.netlify.com/blog/2016/11/17/serverless-file-uploads/ -->
</html>
